name: CI

on:
  push:
    branches: [ main ]

jobs:
  unit-tests:
    runs-on: ubuntu-latest

    env:
      DISPLAY: :99

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install Xvfb (for headless GUI tests)
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb
          # start Xvfb in background for tests that require a DISPLAY
          Xvfb :99 -screen 0 1024x768x16 &

      - name: Build Agent image
        run: docker build -t agent-component ./app/agent_component

      - name: Run Agent Unit Tests
        # mount repo tests directory into the container; adjust container test path as needed
        run: |
          docker run --rm \
            -v "${{ github.workspace }}/tests":/home/hostuser/workspace/tests \
            --entrypoint pytest \
            agent-component \
            /home/hostuser/workspace/tests

      - name: Build Simulator image
        run: docker build -t simulator-component ./app/simulator_component

      - name: Run Simulator Unit Tests
        run: |
          docker run --rm \
            -v "${{ github.workspace }}/tests":/home/hostuser/workspace/tests \
            --entrypoint pytest \
            simulator-component \
            /home/hostuser/workspace/tests
