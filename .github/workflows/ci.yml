name: CI

on:
  push:
    branches: [ main ]

env:
  DISPLAY: :99

jobs:
  setup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GH_TOKEN }}

      - name: Pull or rebuild images if missing
        run: |
          cd scripts
          chmod +x app_build.sh
          ./app_build.sh

  mqtt-broker:
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

  agent-tests:
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Xvfb
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb
          Xvfb :99 -screen 0 1024x768x16 &

      - name: Log in to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GH_TOKEN }}

      - name: Pull Agent image
        run: docker pull ghcr.io/j-automationlab/agent:latest

      - name: Run Agent Unit Tests
        run: |
          docker run --rm -e DISPLAY=${DISPLAY} ghcr.io/j-automationlab/agent:latest pytest -v ./tests

  simulator-tests:
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Xvfb
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb
          Xvfb :99 -screen 0 1024x768x16 &

      - name: Log in to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GH_TOKEN }}

      - name: Pull Simulator image
        run: docker pull ghcr.io/j-automationlab/simulator:latest

      - name: Run Simulator Unit Tests
        run: |
          docker run --rm -e DISPLAY=${DISPLAY} ghcr.io/j-automationlab/simulator:latest pytest -v ./tests
