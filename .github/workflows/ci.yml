name: CI

on:
  push:
    branches: [ main ]

jobs:
  unit-tests:
    runs-on: ubuntu-latest

    env:
      DISPLAY: :99

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Start virtual X server (for headless GUI)
      - name: Install Xvfb
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb
          Xvfb :99 -screen 0 1024x768x16 &

      # 3️⃣ Log in to GitHub Container Registry
      - name: Log in to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GH_TOKEN }}

      # 4️⃣ Pull prebuilt images
      - name: Pull Agent image
        run: docker pull ghcr.io/<username>/agent-component:latest

      - name: Pull Simulator image
        run: docker pull ghcr.io/<username>/simulator-component:latest

      # 5️⃣ Run Agent Unit Tests
      - name: Run Agent Unit Tests
        run: |
          docker run --rm -e DISPLAY=:99 ghcr.io/<username>/agent-component:latest pytest -v ./tests

      # 6️⃣ Run Simulator Unit Tests
      - name: Run Simulator Unit Tests
        run: |
          docker run --rm -e DISPLAY=:99 -e PYTHONPATH=/home/hostuser/workspace/simulator_component ghcr.io/<username>/simulator-component:latest pytest -v ./tests
