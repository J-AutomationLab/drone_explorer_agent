name: CI

on:
  push:
    branches: [main]

env:
  DISPLAY: :99

jobs:
  docker-compose-tests:
    runs-on: ubuntu-latest
    steps:
      # 1️⃣ Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Install Docker and Docker Compose
      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Install Docker Compose CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose

      # 3️⃣ Start virtual X server
      - name: Start Xvfb
        run: |
          sudo apt-get install -y xvfb
          Xvfb :99 -screen 0 1024x768x16 &

      # 4️⃣ Log in to GHCR
      - name: Log in to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GH_TOKEN }}

      # 5️⃣ Pull all prebuilt images
      - name: Pull GHCR images
        run: |
          docker pull ghcr.io/j-automationlab/mqtt_broker:latest
          docker pull ghcr.io/j-automationlab/simulator:latest
          docker pull ghcr.io/j-automationlab/agent:latest

      # 6️⃣ Run docker-compose tests using the pulled images
      - name: Run Agent Tests
        run: |
          docker compose -f ./app/docker-compose.yml run --rm \
            -e DISPLAY=${DISPLAY} \
            --entrypoint pytest agent -v ./tests -p no:warnings

      - name: Run Simulator Tests
        run: |
          docker compose -f ./app/docker-compose.yml run --rm \
            -e DISPLAY=${DISPLAY} \
            --entrypoint pytest simulator-headless -v ./tests -p no:warnings
